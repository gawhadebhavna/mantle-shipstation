<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <service verb="ship" noun="OrderItems">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="orderPartSeqId" required="true"/>
            <parameter name="tryAutoPackage" type="Boolean" default="true"/>
            <parameter name="shipDate" type="Timestamp" default="ec.user.nowTimestamp"/>
            <parameter name="itemList" type="List" required="true">
                <parameter name="itemMap" type="Map">
                    <parameter name="orderItemList"/>
                    <parameter name="quantity"/>
                </parameter>
            </parameter>
            <parameter name="trackingNumber" required="true"/>
            <parameter name="carrier" required="true"/>
            <parameter name="labelDate"/>
        </in-parameters>
        <out-parameters>
            <parameter name="shipmentId"/>
        </out-parameters>
        <actions>
            <!-- create#OrderItemsShipment has transaction=cache so make it not init the tx cache with transaction=use-or-begin -->
            <service-call name="mantle.shipstation.OmsShipmentService.create#OrderItemsShipment" out-map="context"
                          in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, createPackage:true, entryDate:shipDate,
                                   tryAutoPackage:tryAutoPackage, trackingNumber:trackingNumber, carrier:carrier, labelDate:labelDate]"/>

            <entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true">
                <econdition field-name="enumGroupEnumId" value="EngItemsProduct"/>
            </entity-find>

            <set field="productItemTypes" from="productItemTypeEgms*.enumId"/>
            <!-- pack all items (Creating ShipmentPackageContent and AssetIssuance records) -->
            <iterate list="itemList" entry="item">
                <entity-find-one entity-name="mantle.order.OrderItem" value-field="orderItem">
                    <field-map field-name="orderId" from="orderId"/>
                    <field-map field-name="orderItemSeqId" from="item.orderItemSeqId"/>
                </entity-find-one>
                <if condition="orderItem.productId &amp;&amp; productItemTypes.contains(orderItem.itemTypeEnumId)">
                    <service-call name="mantle.shipment.ShipmentServices.pack#ShipmentProduct" in-map="[productId:orderItem.productId,
                                        quantity:item.quantity, shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackageSeqId]"/>
                </if>
            </iterate>
        </actions>
    </service>

</services>